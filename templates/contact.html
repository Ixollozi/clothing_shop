{% extends "base.html" %}
{% load i18n %}
{% load translation_tags %}

{% block title %}{% trans "Contacts" %} - {{ store_name }}{% endblock %}

{% block content %}
    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <h1>{% trans "Contacts" %}</h1>
            <nav class="breadcrumbs">
                <a href="{% url 'index' %}">{% trans "Home" %}</a> / <span>{% trans "Contacts" %}</span>
            </nav>
        </div>
    </section>

    <!-- Contact Content -->
    <section class="contact-section">
        <div class="container">
            <div class="contact-layout">
                <!-- Contact Info -->
                <div class="contact-info">
                    <h2>{% trans "Contact Us" %}</h2>
                    <p>{% trans "We are always happy to answer your questions and help you choose products. Contact us in any convenient way." %}</p>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <div class="contact-details">
                            <h3>{% trans "Phone" %}</h3>
                            {% if contact_info.phone %}<p>{{ contact_info.phone }}</p>{% else %}<p>+7 (800) 123-45-67</p>{% endif %}
                            {% if contact_info.working_hours.weekdays %}<span class="contact-hours">{{ contact_info.working_hours.weekdays }}</span>{% else %}<span class="contact-hours">{% trans "Mon-Sun: 9:00 - 21:00" %}</span>{% endif %}
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <div class="contact-details">

                            <h3>{% trans "Email" %}</h3>
                            {% if contact_info.email %}<p>{{ contact_info.email }}</p>{% else %}<p>info@fashionstore.ru</p>{% endif %}
                            <span class="contact-hours">{% trans "We will respond within 24 hours" %}</span>
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <div class="contact-details">
                            <h3>{% trans "Address" %}</h3>
                            {% if contact_info.address.full %}<p>{{ contact_info.address.full }}</p>{% else %}<p>{% trans "Tashkent, Example Street, 1" %}</p>{% endif %}
                            {% if contact_info.working_hours.weekdays %}<span class="contact-hours">{% trans "Mon-Fri: 10:00 - 19:00" %}</span>{% endif %}
                        </div>
                    </div>

                    <div class="contact-item">
                        <div class="contact-icon">
                            <i class="fab fa-telegram"></i>
                        </div>
                        <div class="contact-details">
                            <h3>{% trans "Messengers" %}</h3>
                            <p>{% trans "Telegram" %}: @fashionstore</p>
                            {% if contact_info.phone %}<p>{% trans "WhatsApp" %}: {{ contact_info.phone }}</p>{% else %}<p>{% trans "WhatsApp" %}: +7 (800) 123-45-67</p>{% endif %}

                        </div>
                    </div>

                    <div class="social-links-large">
                        <h3>{% trans "We are on social networks" %}</h3>
                        <div class="social-links">
                            {% if social_links.instagram %}<a href="{{ social_links.instagram }}"><i class="fab fa-instagram"></i></a>{% endif %}
                            {% if social_links.facebook %}<a href="{{ social_links.facebook }}"><i class="fab fa-facebook"></i></a>{% endif %}
                            {% if social_links.twitter %}<a href="{{ social_links.twitter }}"><i class="fab fa-twitter"></i></a>{% endif %}
                            {% if social_links.vk %}<a href="{{ social_links.vk }}"><i class="fab fa-vk"></i></a>{% endif %}
                            {% if social_links.telegram %}<a href="{{ social_links.telegram }}"><i class="fab fa-telegram"></i></a>{% endif %}
                        </div>
                    </div>
                </div>

                <!-- Contact Form -->
                <div class="contact-form-container">
                    <h2>{% trans "Write to Us" %}</h2>
                    <form class="contact-form">
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="name">{% trans "Name" %} *</label>
                            <input type="text" id="name" name="name" required>
                        </div>
                        <div class="form-group">
                            <label for="email">{% trans "Email" %} *</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">{% trans "Phone" %}</label>
                            <input type="tel" id="phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label for="subject">{% trans "Subject" %} *</label>
                            <select id="subject" name="subject" required>
                                <option value="">{% trans "Choose a topic" %}</option>
                                <option value="order">{% trans "Order question" %}</option>
                                <option value="product">{% trans "Product question" %}</option>
                                <option value="delivery">{% trans "Delivery" %}</option>
                                <option value="return">{% trans "Return" %}</option>
                                <option value="other">{% trans "Other" %}</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="message">{% trans "Message" %} *</label>
                            <textarea id="message" name="message" rows="6" required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary btn-large">{% trans "Send Message" %}</button>
                    </form>
                </div>
            </div>

            <!-- Map Section -->
            <div class="map-section">
                <h2>{% trans "How to Find Us" %}</h2>
                {% if contact_info.map_url %}
                    <div class="yandex-map-container">
                        <iframe 
                            src="{{ contact_info.map_url|yandex_map_url }}?lang=ru_RU" 
                            width="100%" 
                            height="400" 
                            frameborder="0" 
                            allowfullscreen="true" 
                            style="position:relative; border-radius: 10px;">
                        </iframe>
                    </div>
                {% else %}
                    <div class="map-placeholder">
                        <i class="fas fa-map-marked-alt"></i>
                        <p>{% trans "Map will be here" %}</p>
                        {% if contact_info.address.full %}<p class="map-address">{{ contact_info.address.full }}</p>{% else %}<p class="map-address">{% trans "Tashkent, Example Street, 1" %}</p>{% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
    document.querySelector('.contact-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const form = this;
        const submitButton = form.querySelector('button[type="submit"]');
        const originalText = submitButton.textContent;
        
        // Получаем данные формы
        const formData = {
            name: document.getElementById('name').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            subject: document.getElementById('subject').value,
            message: document.getElementById('message').value
        };
        
        // Валидация
        if (!formData.name || !formData.email || !formData.subject || !formData.message) {
            showNotification('{% trans "Please fill in all required fields." %}', 'warning');
            return;
        }
        
        // Отключаем кнопку
        submitButton.disabled = true;
        submitButton.textContent = '{% trans "Sending..." %}';
        
        try {
            // Получаем CSRF токен
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                             getCookie('csrftoken') ||
                             document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            
            if (!csrftoken) {
                throw new Error('CSRF token not found');
            }
            
            // Отправляем данные на сервер
            const response = await fetch('/api/contact/submit/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                credentials: 'same-origin',
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (response.ok && data.success) {
                showNotification(
                    '{% trans "Thank you for your message! We will contact you soon." %}',
                    'success',
                    '{% trans "Message Sent!" %}',
                    5000
                );
                form.reset();
            } else {
                throw new Error(data.error || 'Failed to send message');
            }
        } catch (error) {
            console.error('Error:', error);
            showNotification(
                error.message || '{% trans "An error occurred while sending the message. Please try again later." %}',
                'error',
                '{% trans "Error" %}',
                6000
            );
        } finally {
            // Включаем кнопку обратно
            submitButton.disabled = false;
            submitButton.textContent = originalText;
        }
    });
    
    // Функция для получения CSRF токена из cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock %}
